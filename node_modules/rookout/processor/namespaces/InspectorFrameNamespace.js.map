{"version":3,"sources":["../../../../src/processor/namespaces/InspectorFrameNamespace.js"],"names":["path","require","InspectorFrameNamespace","Namespace","constructor","inspector","frame","scopes","this","undefined","rawPosition","position","readAttribute","name","populateScopes","JSObjectNamespace","scope","Object","keys","object","includes","RookAttributeNotFound","callMethod","args","filename","line","function","locals","dump","getPosition","module","result","depth","dumpConfig","parseInt","isNaN","dumpConfigs","toLowerCase","RookInvalidMethodArguments","i","length","k","maxDepth","ContainerNamespace","script","getScript","location","scriptId","rawFilename","url","basename","lineNumber","column","columnNumber","functionName","mapConsumer","originalPosition","getOriginalPosition","source","String","session","index","global","__rookout_backchannel","add","context","get","scopeChain","scopeId","remoteScope","nextRemoteScope","active","type","push","error","post","objectId","functionDeclaration","e","_this","delete"],"mappings":"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","sourcesContent":["import Namespace from \"./Namespace\";\r\nimport JSObjectNamespace, { dumpConfigs } from './JSObjectNamespace'\r\nimport { RookAttributeNotFound, RookInvalidMethodArguments } from '../../exceptions'\r\nimport ContainerNamespace from \"./ContainerNamespace\";\r\nconst path = require(\"path\");\r\n\r\nexport default class InspectorFrameNamespace extends Namespace {\r\n    constructor(inspector, frame) {\r\n        super();\r\n\r\n        this.inspector = inspector;\r\n        this.frame = frame;\r\n        this.scopes = null;\r\n        this.this = undefined;\r\n\r\n        this.rawPosition = null;\r\n        this.position = null;\r\n    }\r\n\r\n    readAttribute(name) {\r\n        this.populateScopes();\r\n\r\n        if (name === 'this') {\r\n            return new JSObjectNamespace(this.this);\r\n        }\r\n\r\n        for (let scope of this.scopes) {\r\n            if (Object.keys(scope.object).includes(name)) {\r\n                return new JSObjectNamespace(scope.object[name]);\r\n            }\r\n        }\r\n\r\n        throw new RookAttributeNotFound(name);\r\n    }\r\n\r\n    callMethod(name, args) {\r\n        switch (name) {\r\n            case \"filename\":\r\n            case \"module\":\r\n                return this.filename();\r\n            case \"line\":\r\n                return this.line();\r\n            case \"function\":\r\n            case \"method\":\r\n                return this.function();\r\n            case \"locals\":\r\n                return this.locals(args);\r\n            case \"dump\":\r\n                return this.dump(args);\r\n            default:\r\n                return super.callMethod(name, args);\r\n        }\r\n    }\r\n\r\n    filename() {\r\n        return new JSObjectNamespace(this.getPosition().filename);\r\n    }\r\n\r\n    module() {\r\n        return this.filename();\r\n    }\r\n\r\n    line() {\r\n        return new JSObjectNamespace(this.getPosition().line);\r\n    }\r\n\r\n    function() {\r\n        return new JSObjectNamespace(this.getPosition().function);\r\n    }\r\n\r\n    locals(args) {\r\n        this.populateScopes();\r\n\r\n        let result = {};\r\n\r\n        let depth = null;\r\n        let dumpConfig = null;\r\n\r\n        if (null != args && '' !== args) {\r\n            depth = parseInt(args);\r\n\r\n            if (isNaN(depth)) {\r\n                depth = null;\r\n                dumpConfig = dumpConfigs[args.toLowerCase()];\r\n\r\n                if (dumpConfig === undefined) {\r\n                    throw new RookInvalidMethodArguments('locals()', args);\r\n                }\r\n            }\r\n        }\r\n\r\n        for (let i = this.scopes.length - 1; i >= 0; i--) {\r\n            for (let k of Object.keys(this.scopes[i].object)) {\r\n                result[k] = new JSObjectNamespace(this.scopes[i].object[k], dumpConfig);\r\n\r\n                if (depth !== null && dumpConfig == null) {\r\n                    result[k].dumpConfig.maxDepth = depth;\r\n                }\r\n            }\r\n        }\r\n\r\n        result.this = new JSObjectNamespace(this.this);\r\n\r\n        return new ContainerNamespace(result);\r\n    }\r\n\r\n    dump(args) {\r\n        return new ContainerNamespace({\r\n            locals: this.locals(args),\r\n            module: this.module(),\r\n            filename: this.filename(),\r\n            line: this.line(),\r\n            function: this.function(),\r\n        })\r\n    }\r\n\r\n    getPosition() {\r\n        if (this.position !== null) {\r\n            return this.position;\r\n        }\r\n\r\n        const script = this.inspector.getScript(this.frame.location.scriptId);\r\n\r\n        let rawFilename = null;\r\n\r\n        if (script !== null) {\r\n            rawFilename = script.filename;\r\n        } else {\r\n            if (this.frame.url !== undefined) {\r\n                rawFilename = path.basename(this.frame.url);\r\n            }\r\n        }\r\n\r\n        this.rawPosition = {\r\n            filename: rawFilename,\r\n            line: this.frame.location.lineNumber + 1,\r\n            column: this.frame.location.columnNumber,\r\n            function: this.frame.functionName\r\n        };\r\n\r\n        if (null !== script && null !== script.mapConsumer) {\r\n            let originalPosition = script.getOriginalPosition(this.rawPosition.line, this.rawPosition.column);\r\n            if (null != originalPosition) {\r\n                // In case of bad mapping we skip the resolve.\r\n                if (originalPosition.line === null) {\r\n                    originalPosition = this.rawPosition;\r\n                }\r\n\r\n                this.position = {\r\n                    filename: originalPosition.source,\r\n                    line: originalPosition.line,\r\n                    column: originalPosition.column,\r\n                    function: this.rawPosition.function\r\n                };\r\n\r\n                if (this.position.function === '' &&\r\n                    (typeof originalPosition.name === 'string' || originalPosition.name instanceof String)) {\r\n                    this.position.function = originalPosition.name;\r\n                }\r\n            }\r\n        }\r\n\r\n        // If we have been unable to get original position, just use raw position\r\n        if (null == this.position) {\r\n            this.position = this.rawPosition;\r\n        }\r\n\r\n        if (this.position.function === '') {\r\n            this.position.function = 'anonymous';\r\n        }\r\n\r\n        return this.position;\r\n    }\r\n\r\n    populateScopes() {\r\n        if (this.scopes !== null) {\r\n            return;\r\n        }\r\n\r\n        let scopes = [];\r\n\r\n        let session = this.inspector;\r\n        let index = global.__rookout_backchannel.add();\r\n\r\n        try {\r\n            let context = global.__rookout_backchannel.get(index);\r\n            let scopeChain = this.frame.scopeChain;\r\n\r\n            context.scopes = [];\r\n\r\n            for (let scopeId = 0; scopeId < scopeChain.length; scopeId++) {\r\n                let remoteScope = scopeChain[scopeId];\r\n                let nextRemoteScope = scopeChain[scopeId + 1];\r\n\r\n                let active = ((remoteScope.type === 'local' || remoteScope.type === 'catch' || remoteScope.type === 'block') ||\r\n                    (remoteScope.type === 'closure' && (nextRemoteScope === undefined || nextRemoteScope.type !== 'global')));\r\n\r\n                if (!active) continue;\r\n\r\n                let scope = {};\r\n                scope.type = remoteScope.type;\r\n                scope.object = {};\r\n                context.scopes.push(scope);\r\n\r\n                let error = null;\r\n\r\n                session.post('Runtime.callFunctionOn', {\r\n                    objectId: remoteScope.object.objectId,\r\n                    functionDeclaration: `\r\n                        function copy() {\r\n                          let scopes = global.__rookout_backchannel.get(${index}).scopes;\r\n                          scopes[scopes.length - 1].object = this;\r\n                         }\r\n                        `\r\n                }, (e) => {\r\n                    error = e;\r\n                });\r\n\r\n\r\n                if (error !== null) {\r\n                    throw error;\r\n                }\r\n\r\n                scopes = context.scopes;\r\n            }\r\n\r\n            session.post('Runtime.callFunctionOn', {\r\n                objectId: this.frame.this.objectId,\r\n                functionDeclaration: `\r\n                        function copy() {\r\n                          global.__rookout_backchannel.get(${index}).this = this;\r\n                         }\r\n                        `\r\n            });\r\n\r\n            let _this = global.__rookout_backchannel.get(index).this;\r\n\r\n            if (_this === global) {\r\n                _this = undefined;\r\n            }\r\n\r\n            this.this = _this;\r\n        } finally {\r\n            global.__rookout_backchannel.delete(index);\r\n            this.scopes = scopes;\r\n        }\r\n    }\r\n}\r\n"],"file":"InspectorFrameNamespace.js"}