{"version":3,"sources":["../../../src/com_ws/OutputWs.js"],"names":["config","require","messages_pb","variant_pb","timestamp_pb","LOG_LEVELS","LogMessage","LogLevel","DEBUG","INFO","WARNING","ERROR","FATAL","OutputWs","constructor","id","_agentCom","_ruleStatusUpdatesBucket","TokenBucket","OutputWsConfiguration","MAX_STATUS_UPDATES","BUCKET_REFRESH_RATE","logger","error","_userMessageBucket","MAX_AUG_MESSAGES","_logMessageBucket","MAX_LOG_ITEMS","_internalSendLogMessage","__filename","registerOutput","setAgentCom","agentCom","flushMessages","callback","msgsFlushedPromise","then","catch","sendRuleStatus","ruleId","active","doIfAvailable","ruleStatusMessage","RuleStatusMessage","setAgentId","setRuleId","setActive","setError","_convertError","dumps","add","new_err","Error","setMessage","getMessage","setType","getType","setParameters","getParameters","setExc","getExc","setTraceback","getTraceback","sendUserMessage","augId","messageId","args","msg","AugReportMessage","setAugId","setReportId","setArguments","NamespaceSerializer","sendLogMessage","level","time","filename","lineno","text","formattedMessage","date","Timestamp","fromDate","Date","setTimestamp","logLevel","undefined","setLevel","setFilename","setLine","setText","setFormattedMessage","setLegacyArguments","sendWarning"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;;;AACA,MAAMA,MAAM,GAAGC,OAAO,CAAC,WAAD,CAAtB;;AAEA,MAAMC,WAAW,GAAGD,OAAO,CAAC,yBAAD,CAA3B;;AACA,MAAME,UAAU,GAAGF,OAAO,CAAC,wBAAD,CAA1B;;AACA,MAAMG,YAAY,GAAGH,OAAO,CAAC,8CAAD,CAA5B,C,CAEA;;;AACA,MAAMI,UAAU,GAAG;AACf,KAAGH,WAAW,CAACI,UAAZ,CAAuBC,QAAvB,CAAgCC,KADpB;AAEf,KAAGN,WAAW,CAACI,UAAZ,CAAuBC,QAAvB,CAAgCE,IAFpB;AAGf,KAAGP,WAAW,CAACI,UAAZ,CAAuBC,QAAvB,CAAgCG,OAHpB;AAIf,KAAGR,WAAW,CAACI,UAAZ,CAAuBC,QAAvB,CAAgCI,KAJpB;AAKf,KAAGT,WAAW,CAACI,UAAZ,CAAuBC,QAAvB,CAAgCK;AALpB,CAAnB;;AAQe,MAAMC,QAAN,CAAe;AAC1BC,EAAAA,WAAW,CAACC,EAAD,EAAK;AACZ,SAAKA,EAAL,GAAUA,EAAV;AACA,SAAKC,SAAL,GAAiB,IAAjB;AAEA,SAAKC,wBAAL,GAAgC,IAAIC,oBAAJ,CAC5BlB,MAAM,CAACmB,qBAAP,CAA6BC,kBADD,EAE5BpB,MAAM,CAACmB,qBAAP,CAA6BE,mBAFD,EAG5B,MAAMC,eAAOC,KAAP,CAAa,wCAAb,CAHsB,CAAhC;AAKA,SAAKC,kBAAL,GAA0B,IAAIN,oBAAJ,CACtBlB,MAAM,CAACmB,qBAAP,CAA6BM,gBADP,EAEtBzB,MAAM,CAACmB,qBAAP,CAA6BE,mBAFP,EAGtB,MAAMC,eAAOC,KAAP,CAAa,6CAAb,CAHgB,CAA1B;AAKA,SAAKG,iBAAL,GAAyB,IAAIR,oBAAJ,CACrBlB,MAAM,CAACmB,qBAAP,CAA6BQ,aADR,EAErB3B,MAAM,CAACmB,qBAAP,CAA6BE,mBAFR,EAGrB,MAAM,KAAKO,uBAAL,CACF,CADE,EAEFC,UAFE,EAGF,CAHE,EAIF,sCAJE,EAKF,sCALE,CAHe,CAAzB;;AAUAP,mBAAOQ,cAAP,CAAsB,IAAtB;AACH;;AAEDC,EAAAA,WAAW,CAACC,QAAD,EAAW;AAClB,SAAKhB,SAAL,GAAiBgB,QAAjB;AACH;;AAEDC,EAAAA,aAAa,CAACC,QAAD,EAAW;AACpB,QAAIC,kBAAkB,GAAG,KAAKnB,SAAL,CAAeiB,aAAf,EAAzB;;AACAE,IAAAA,kBAAkB,CAACC,IAAnB,CAAwBF,QAAxB,EAAkCG,KAAlC,CAAwCH,QAAxC;AACH;;AAEDI,EAAAA,cAAc,CAACC,MAAD,EAASC,MAAT,EAAiBjB,KAAjB,EAAwB;AAClC,QAAI,CAAC,KAAKP,SAAV,EAAqB;AACjB;AACH;;AAED,SAAKC,wBAAL,CAA8BwB,aAA9B,CAA4C,MAAM;AAC9C,UAAIC,iBAAiB,GAAG,IAAIxC,WAAW,CAACyC,iBAAhB,EAAxB;AACAD,MAAAA,iBAAiB,CAACE,UAAlB,CAA6B,KAAK7B,EAAlC;AACA2B,MAAAA,iBAAiB,CAACG,SAAlB,CAA4BN,MAA5B;AACAG,MAAAA,iBAAiB,CAACI,SAAlB,CAA4BN,MAA5B;;AAEA,UAAIjB,KAAJ,EAAW;AACPmB,QAAAA,iBAAiB,CAACK,QAAlB,CAA2BlC,QAAQ,CAACmC,aAAT,CAAuBzB,KAAK,CAAC0B,KAAN,EAAvB,CAA3B;AACH;;AAED,WAAKjC,SAAL,CAAekC,GAAf,CAAmBR,iBAAnB;AACH,KAXD;AAYH;;AAED,SAAOM,aAAP,CAAqBzB,KAArB,EAA4B;AACxB,QAAI4B,OAAO,GAAG,IAAIhD,UAAU,CAACiD,KAAf,EAAd;AACAD,IAAAA,OAAO,CAACE,UAAR,CAAmB9B,KAAK,CAAC+B,UAAN,EAAnB;AACAH,IAAAA,OAAO,CAACI,OAAR,CAAgBhC,KAAK,CAACiC,OAAN,EAAhB;AACAL,IAAAA,OAAO,CAACM,aAAR,CAAsBlC,KAAK,CAACmC,aAAN,EAAtB;AACAP,IAAAA,OAAO,CAACQ,MAAR,CAAepC,KAAK,CAACqC,MAAN,EAAf;AACAT,IAAAA,OAAO,CAACU,YAAR,CAAqBtC,KAAK,CAACuC,YAAN,EAArB;AAEA,WAAOX,OAAP;AACH;;AAEDY,EAAAA,eAAe,CAACC,KAAD,EAAQC,SAAR,EAAmBC,IAAnB,EAAyB;AACpC,QAAI,CAAC,KAAKlD,SAAV,EAAqB;AACjB;AACH;;AAED,SAAKQ,kBAAL,CAAwBiB,aAAxB,CAAsC,MAAM;AACxC,UAAI0B,GAAG,GAAG,IAAIjE,WAAW,CAACkE,gBAAhB,EAAV;AACAD,MAAAA,GAAG,CAACvB,UAAJ,CAAe,KAAK7B,EAApB;AACAoD,MAAAA,GAAG,CAACE,QAAJ,CAAaL,KAAb;AACAG,MAAAA,GAAG,CAACG,WAAJ,CAAgBL,SAAhB;;AAEA,UAAIC,IAAJ,EAAU;AACNC,QAAAA,GAAG,CAACI,YAAJ,CAAiB,IAAIC,4BAAJ,GAA0BvB,KAA1B,CAAgCiB,IAAhC,CAAjB;AACH;;AAED,WAAKlD,SAAL,CAAekC,GAAf,CAAmBiB,GAAnB;AACH,KAXD;AAYH;;AAEDM,EAAAA,cAAc,CAACC,KAAD,EAAQC,IAAR,EAAcC,QAAd,EAAwBC,MAAxB,EAAgCC,IAAhC,EAAsCC,gBAAtC,EAAwDb,IAAxD,EAA8D;AACxE,QAAI,CAAC,KAAKlD,SAAV,EAAqB;AACjB;AACH;;AAED,SAAKU,iBAAL,CAAuBe,aAAvB,CAAqC,MACjC,KAAKb,uBAAL,CAA6B8C,KAA7B,EAAoCE,QAApC,EAA8CC,MAA9C,EAAsDC,IAAtD,EAA4DC,gBAA5D,EAA8Eb,IAA9E,CADJ;AAGH;;AAEDtC,EAAAA,uBAAuB,CAAC8C,KAAD,EAAQE,QAAR,EAAkBC,MAAlB,EAA0BC,IAA1B,EAAgCC,gBAAhC,EAAkDb,IAAlD,EAAwD;AAC3E,QAAI,CAAC,KAAKlD,SAAV,EAAqB;AACjB;AACH;;AAED,QAAImD,GAAG,GAAG,IAAIjE,WAAW,CAACI,UAAhB,EAAV;AAEA,QAAI0E,IAAI,GAAG,IAAI5E,YAAY,CAAC6E,SAAjB,EAAX;AACAD,IAAAA,IAAI,CAACE,QAAL,CAAc,IAAIC,IAAJ,EAAd;AACAhB,IAAAA,GAAG,CAACiB,YAAJ,CAAiBJ,IAAjB;AAEA,QAAIK,QAAQ,GAAGhF,UAAU,CAACqE,KAAD,CAAzB;;AACA,QAAIW,QAAQ,KAAKC,SAAjB,EAA4B;AACxBD,MAAAA,QAAQ,GAAGnF,WAAW,CAACI,UAAZ,CAAuBC,QAAvB,CAAgCG,OAA3C;AACH;;AAEDyD,IAAAA,GAAG,CAACvB,UAAJ,CAAe,KAAK7B,EAApB;AACAoD,IAAAA,GAAG,CAACoB,QAAJ,CAAaF,QAAb;AACAlB,IAAAA,GAAG,CAACqB,WAAJ,CAAgBZ,QAAhB;AACAT,IAAAA,GAAG,CAACsB,OAAJ,CAAYZ,MAAZ;AACAV,IAAAA,GAAG,CAACuB,OAAJ,CAAYZ,IAAZ;AACAX,IAAAA,GAAG,CAACwB,mBAAJ,CAAwBZ,gBAAxB;;AACA,QAAIb,IAAJ,EAAU;AACNC,MAAAA,GAAG,CAACyB,kBAAJ,CAAuB,IAAIpB,4BAAJ,GAA0BvB,KAA1B,CAAgCiB,IAAhC,CAAvB;AACH;;AAED,SAAKlD,SAAL,CAAekC,GAAf,CAAmBiB,GAAnB;AACH;;AAED0B,EAAAA,WAAW,CAACtD,MAAD,EAAShB,KAAT,EAAgB;AACvB,SAAKe,cAAL,CAAoBC,MAApB,EAA4B,SAA5B,EAAuChB,KAAvC;AACH;;AA/HyB","sourcesContent":["import NamespaceSerializer from \"../processor/NamespaceSerializer\";\nimport {logger} from \"../logger\";\nimport TokenBucket from \"./TokenBucket\";\nconst config = require(\"../config\");\n\nconst messages_pb = require(\"../protobuf/messages_pb\");\nconst variant_pb = require(\"../protobuf/variant_pb\");\nconst timestamp_pb = require(\"google-protobuf/google/protobuf/timestamp_pb\");\n\n// Maps logger.js:LOG_LEVELS to the LogMessage enum\nconst LOG_LEVELS = {\n    0: messages_pb.LogMessage.LogLevel.DEBUG,\n    1: messages_pb.LogMessage.LogLevel.INFO,\n    2: messages_pb.LogMessage.LogLevel.WARNING,\n    3: messages_pb.LogMessage.LogLevel.ERROR,\n    4: messages_pb.LogMessage.LogLevel.FATAL\n};\n\nexport default class OutputWs {\n    constructor(id) {\n        this.id = id;\n        this._agentCom = null;\n\n        this._ruleStatusUpdatesBucket = new TokenBucket(\n            config.OutputWsConfiguration.MAX_STATUS_UPDATES,\n            config.OutputWsConfiguration.BUCKET_REFRESH_RATE,\n            () => logger.error(\"Limit reached, dropping status updates\"));\n\n        this._userMessageBucket = new TokenBucket(\n            config.OutputWsConfiguration.MAX_AUG_MESSAGES,\n            config.OutputWsConfiguration.BUCKET_REFRESH_RATE,\n            () => logger.error(\"Limit reached, dropping aug report messages\"));\n\n        this._logMessageBucket = new TokenBucket(\n            config.OutputWsConfiguration.MAX_LOG_ITEMS,\n            config.OutputWsConfiguration.BUCKET_REFRESH_RATE,\n            () => this._internalSendLogMessage(\n                3,\n                __filename,\n                0,\n                \"Limit reached, dropping log messages\",\n                \"Limit reached, dropping log messages\"));\n\n        logger.registerOutput(this);\n    }\n\n    setAgentCom(agentCom) {\n        this._agentCom = agentCom;\n    }\n\n    flushMessages(callback) {\n        let msgsFlushedPromise = this._agentCom.flushMessages();\n        msgsFlushedPromise.then(callback).catch(callback);\n    }\n\n    sendRuleStatus(ruleId, active, error) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        this._ruleStatusUpdatesBucket.doIfAvailable(() => {\n            let ruleStatusMessage = new messages_pb.RuleStatusMessage();\n            ruleStatusMessage.setAgentId(this.id);\n            ruleStatusMessage.setRuleId(ruleId);\n            ruleStatusMessage.setActive(active);\n\n            if (error) {\n                ruleStatusMessage.setError(OutputWs._convertError(error.dumps()));\n            }\n\n            this._agentCom.add(ruleStatusMessage);\n        });\n    }\n\n    static _convertError(error) {\n        let new_err = new variant_pb.Error();\n        new_err.setMessage(error.getMessage());\n        new_err.setType(error.getType());\n        new_err.setParameters(error.getParameters());\n        new_err.setExc(error.getExc());\n        new_err.setTraceback(error.getTraceback());\n\n        return new_err\n    }\n\n    sendUserMessage(augId, messageId, args) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        this._userMessageBucket.doIfAvailable(() => {\n            let msg = new messages_pb.AugReportMessage();\n            msg.setAgentId(this.id);\n            msg.setAugId(augId);\n            msg.setReportId(messageId);\n\n            if (args) {\n                msg.setArguments(new NamespaceSerializer().dumps(args));\n            }\n\n            this._agentCom.add(msg);\n        });\n    }\n\n    sendLogMessage(level, time, filename, lineno, text, formattedMessage, args) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        this._logMessageBucket.doIfAvailable(() =>\n            this._internalSendLogMessage(level, filename, lineno, text, formattedMessage, args)\n        );\n    }\n\n    _internalSendLogMessage(level, filename, lineno, text, formattedMessage, args) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        let msg = new messages_pb.LogMessage();\n\n        let date = new timestamp_pb.Timestamp();\n        date.fromDate(new Date());\n        msg.setTimestamp(date);\n\n        let logLevel = LOG_LEVELS[level];\n        if (logLevel === undefined) {\n            logLevel = messages_pb.LogMessage.LogLevel.WARNING\n        }\n\n        msg.setAgentId(this.id);\n        msg.setLevel(logLevel);\n        msg.setFilename(filename);\n        msg.setLine(lineno);\n        msg.setText(text);\n        msg.setFormattedMessage(formattedMessage);\n        if (args) {\n            msg.setLegacyArguments(new NamespaceSerializer().dumps(args));\n        }\n\n        this._agentCom.add(msg);\n    }\n\n    sendWarning(ruleId, error) {\n        this.sendRuleStatus(ruleId, \"Warning\", error);\n    }\n}\n"],"file":"OutputWs.js"}